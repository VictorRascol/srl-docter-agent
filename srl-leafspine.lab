name: srl-docter-lab

topology:
  kinds:
    srl:
      # Need IXR D2 or D3 for EVPN/VXLAN support
      type: ixrd2 # See https://www.nokia.com/networks/products/7250-interconnect-router/
      image: srl/docter-agent:latest

  nodes:
  
  ###### DC FABRIC ######
  
    spine1: { kind: srl, startup-config: auto-spine.cfg.json }
    leaf1:  { kind: srl, startup-config: auto-leaf.cfg.json }
    leaf2:  { kind: srl, startup-config: auto-leaf.cfg.json }
    
  ###### TELEMETRY STACK ######

    grafana: # Added, connect via mgmt network
      kind: linux
      publish:
       - tcp/3000     # tcp port 3000 will be exposed via mysocket.io
      image: grafana/grafana:7.3.7
      env:
        GF_INSTALL_PLUGINS: agenty-flowcharting-panel,agenty-flowcharting-panel
      binds:
        - configs/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
        - configs/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
        - configs/grafana/dashboards:/var/lib/grafana/dashboards
      mgmt_ipv4: 172.20.20.10 # Pick a fixed IP
      mgmt_ipv6: 2001:172:20:20::10

    telegraf: # Added, connect via mgmt network
      kind: linux
      image: telegraf
      binds: 
        - configs/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      mgmt_ipv4: 172.20.20.11 # Pick a fixed IP
      mgmt_ipv6: 2001:172:20:20::11
      
    influxdb: # Added, connect via mgmt network
      kind: linux
      image: influxdb:1.8
      mgmt_ipv4: 172.20.20.12 # Pick a fixed IP
      mgmt_ipv6: 2001:172:20:20::12
      
    gnmic:
      kind: linux
      image: ghcr.io/karimra/gnmic:0.18.0
      binds:
        - configs/gnmic/gnmic-config.yml:/gnmic-config.yml:ro
      cmd: --config /gnmic-config.yml --log subscribe
      
    prometheus:
      kind: linux
      image: prom/prometheus:v2.23.0
      binds:
        - configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      cmd: --config.file=/etc/prometheus/prometheus.yml
      ports:
        - 9090:9090
      
    mysocketio:
      kind: mysocketio
      image: ghcr.io/hellt/mysocketctl:0.4.0
      binds:
        - .mysocketio_token:/root/.mysocketio_token # bind mount API token

  links:
    - endpoints: ["leaf1:e1-1","spine1:e1-1"]
    - endpoints: ["leaf2:e1-1","spine1:e1-2"]
